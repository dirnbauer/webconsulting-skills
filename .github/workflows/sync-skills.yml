name: Sync External Skills

on:
  # Weekly sync on Monday at 06:00 UTC
  schedule:
    - cron: '0 6 * * 1'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skill_name:
        description: 'Specific skill to sync (leave empty for all)'
        required: false
        default: ''

jobs:
  sync-skills:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Read Sync Configuration
        id: config
        run: |
          echo "Reading .sync-config.json..."
          if [ ! -f ".sync-config.json" ]; then
            echo "No sync configuration found"
            exit 0
          fi
          cat .sync-config.json
      
      - name: Sync Skills
        id: sync
        run: |
          #!/bin/bash
          set -e
          
          CHANGES_MADE=false
          SKILL_FILTER="${{ github.event.inputs.skill_name }}"
          
          # Read skills from config
          SKILLS=$(cat .sync-config.json | jq -r '.skills[] | select(.enabled == true) | @base64')
          
          for skill_b64 in $SKILLS; do
            skill=$(echo "$skill_b64" | base64 --decode)
            name=$(echo "$skill" | jq -r '.name')
            source=$(echo "$skill" | jq -r '.source')
            branch=$(echo "$skill" | jq -r '.branch')
            path=$(echo "$skill" | jq -r '.path // "."')
            
            # Skip if filter specified and doesn't match
            if [ -n "$SKILL_FILTER" ] && [ "$name" != "$SKILL_FILTER" ]; then
              echo "Skipping $name (filter: $SKILL_FILTER)"
              continue
            fi
            
            echo "====================================="
            echo "Syncing skill: $name"
            echo "Source: $source"
            echo "Branch: $branch"
            echo "Path: $path"
            echo "====================================="
            
            # Create temp directory for clone
            TEMP_DIR=$(mktemp -d)
            
            # Clone the repository
            if git clone --depth 1 --branch "$branch" "$source" "$TEMP_DIR" 2>/dev/null; then
              # Determine source directory (support path parameter)
              SOURCE_DIR="$TEMP_DIR/$path"
              
              # Check if SKILL.md exists
              if [ -f "$SOURCE_DIR/SKILL.md" ]; then
                # Ensure target directory exists
                mkdir -p "skills/$name"
                
                # Copy SKILL.md
                cp "$SOURCE_DIR/SKILL.md" "skills/$name/SKILL.md"
                echo "✓ Updated skills/$name/SKILL.md"
                
                # Copy examples directory if exists
                if [ -d "$SOURCE_DIR/examples" ]; then
                  rm -rf "skills/$name/examples"
                  cp -r "$SOURCE_DIR/examples" "skills/$name/"
                  echo "✓ Updated skills/$name/examples/"
                fi
                
                # Copy rules directory if exists
                if [ -d "$SOURCE_DIR/rules" ]; then
                  rm -rf "skills/$name/rules"
                  cp -r "$SOURCE_DIR/rules" "skills/$name/"
                  echo "✓ Updated skills/$name/rules/"
                fi
                
                # Copy references directory if exists
                if [ -d "$SOURCE_DIR/references" ]; then
                  rm -rf "skills/$name/references"
                  cp -r "$SOURCE_DIR/references" "skills/$name/"
                  echo "✓ Updated skills/$name/references/"
                fi
                
                # Copy scripts directory if exists
                if [ -d "$SOURCE_DIR/scripts" ]; then
                  rm -rf "skills/$name/scripts"
                  cp -r "$SOURCE_DIR/scripts" "skills/$name/"
                  echo "✓ Updated skills/$name/scripts/"
                fi
                
                # Check for changes
                if ! git diff --quiet "skills/$name/"; then
                  CHANGES_MADE=true
                  echo "Changes detected in $name"
                fi
              else
                echo "⚠ No SKILL.md found in $source (path: $path)"
              fi
            else
              echo "⚠ Failed to clone $source"
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
          done
          
          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT
      
      - name: Update Sync Timestamp
        if: steps.sync.outputs.changes_made == 'true'
        run: |
          # Update lastSync in config
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          jq --arg ts "$TIMESTAMP" '.lastSync = $ts' .sync-config.json > .sync-config.tmp
          mv .sync-config.tmp .sync-config.json
      
      - name: Check AGENTS.md for missing skills
        if: steps.sync.outputs.changes_made == 'true'
        run: |
          # AGENTS.md is hand-crafted; don't overwrite it.
          # Instead, list any synced skills not yet mentioned.
          echo "Checking AGENTS.md for newly synced skills..."
          MISSING=""
          for skill_dir in skills/*/; do
            if [ -f "${skill_dir}SKILL.md" ]; then
              skill_name=$(basename "$skill_dir")
              if ! grep -q "\`$skill_name\`" AGENTS.md 2>/dev/null; then
                MISSING="$MISSING  - $skill_name\n"
              fi
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "⚠ The following skills are not yet listed in AGENTS.md:"
            echo -e "$MISSING"
            echo "Please add them manually after merging this PR."
          else
            echo "✓ All skills are listed in AGENTS.md"
          fi
      
      - name: Commit and Push to Sync Branch
        if: steps.sync.outputs.changes_made == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          BRANCH="chore/sync-skills"
          git checkout -B "$BRANCH"
          git add skills/ .sync-config.json
          git commit -m "chore: sync external skills"
          git push -f origin "$BRANCH"

      - name: Create Pull Request
        if: steps.sync.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "chore/sync-skills" --state open --json number -q '.[0].number' || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, updated branch."
          else
            cat > /tmp/pr-body.md <<'PREOF'
          ## Skill Synchronization

          This PR updates skills from external repositories as defined in `.sync-config.json`.

          ### Changes
          - Synced skill definitions from upstream sources
          - Updated sync timestamp

          ### Review Checklist
          - [ ] Reviewed skill content changes
          - [ ] Verified no breaking changes
          - [ ] Updated AGENTS.md and README.md if new skills were added
          - [ ] Tested installation with `./install.sh`
          PREOF
            gh pr create \
              --title "chore: Sync External Skills" \
              --body-file /tmp/pr-body.md \
              --base main \
              --head "chore/sync-skills" \
              --label "automated,skills"
          fi

