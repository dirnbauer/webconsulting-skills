name: Sync External Skills

on:
  # Weekly sync on Monday at 06:00 UTC
  schedule:
    - cron: '0 6 * * 1'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skill_name:
        description: 'Specific skill to sync (leave empty for all)'
        required: false
        default: ''

jobs:
  sync-skills:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Read Sync Configuration
        id: config
        run: |
          echo "Reading .sync-config.json..."
          if [ ! -f ".sync-config.json" ]; then
            echo "No sync configuration found"
            exit 0
          fi
          cat .sync-config.json
      
      - name: Sync Skills
        id: sync
        run: |
          #!/bin/bash
          set -e
          
          CHANGES_MADE=false
          SKILL_FILTER="${{ github.event.inputs.skill_name }}"
          
          # Read skills from config
          SKILLS=$(cat .sync-config.json | jq -r '.skills[] | select(.enabled == true) | @base64')
          
          for skill_b64 in $SKILLS; do
            skill=$(echo "$skill_b64" | base64 --decode)
            name=$(echo "$skill" | jq -r '.name')
            source=$(echo "$skill" | jq -r '.source')
            branch=$(echo "$skill" | jq -r '.branch')
            
            # Skip if filter specified and doesn't match
            if [ -n "$SKILL_FILTER" ] && [ "$name" != "$SKILL_FILTER" ]; then
              echo "Skipping $name (filter: $SKILL_FILTER)"
              continue
            fi
            
            echo "====================================="
            echo "Syncing skill: $name"
            echo "Source: $source"
            echo "Branch: $branch"
            echo "====================================="
            
            # Create temp directory for clone
            TEMP_DIR=$(mktemp -d)
            
            # Clone the repository
            if git clone --depth 1 --branch "$branch" "$source" "$TEMP_DIR" 2>/dev/null; then
              # Check if SKILL.md exists
              if [ -f "$TEMP_DIR/SKILL.md" ]; then
                # Ensure target directory exists
                mkdir -p "skills/$name"
                
                # Copy SKILL.md
                cp "$TEMP_DIR/SKILL.md" "skills/$name/SKILL.md"
                echo "✓ Updated skills/$name/SKILL.md"
                
                # Copy examples directory if exists
                if [ -d "$TEMP_DIR/examples" ]; then
                  cp -r "$TEMP_DIR/examples" "skills/$name/"
                  echo "✓ Updated skills/$name/examples/"
                fi
                
                # Check for changes
                if ! git diff --quiet "skills/$name/"; then
                  CHANGES_MADE=true
                  echo "Changes detected in $name"
                fi
              else
                echo "⚠ No SKILL.md found in $source"
              fi
            else
              echo "⚠ Failed to clone $source"
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
          done
          
          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT
      
      - name: Update Sync Timestamp
        if: steps.sync.outputs.changes_made == 'true'
        run: |
          # Update lastSync in config
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          jq --arg ts "$TIMESTAMP" '.lastSync = $ts' .sync-config.json > .sync-config.tmp
          mv .sync-config.tmp .sync-config.json
      
      - name: Regenerate AGENTS.md
        if: steps.sync.outputs.changes_made == 'true'
        run: |
          echo "# Available Agent Skills" > AGENTS.md
          echo "" >> AGENTS.md
          echo "Auto-generated index of all available skills in this marketplace." >> AGENTS.md
          echo "" >> AGENTS.md
          echo "| Skill | Description | Version |" >> AGENTS.md
          echo "|-------|-------------|---------|" >> AGENTS.md
          
          for skill_dir in skills/*/; do
            if [ -f "${skill_dir}SKILL.md" ]; then
              skill_name=$(basename "$skill_dir")
              
              # Extract metadata from YAML frontmatter
              description=$(sed -n '/^---$/,/^---$/p' "${skill_dir}SKILL.md" | grep -E "^description:" | sed 's/description: //' | head -1)
              version=$(sed -n '/^---$/,/^---$/p' "${skill_dir}SKILL.md" | grep -E "^version:" | sed 's/version: //' | head -1)
              
              # Default values if not found
              description=${description:-"No description"}
              version=${version:-"1.0.0"}
              
              echo "| \`$skill_name\` | $description | $version |" >> AGENTS.md
            fi
          done
          
          echo "" >> AGENTS.md
          echo "---" >> AGENTS.md
          echo "*Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> AGENTS.md
      
      - name: Create Pull Request
        if: steps.sync.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync external skills'
          title: 'chore: Sync External Skills'
          body: |
            ## Skill Synchronization
            
            This PR updates skills from external repositories as defined in `.sync-config.json`.
            
            ### Changes
            - Synced skill definitions from upstream sources
            - Updated AGENTS.md index
            - Updated sync timestamp
            
            ### Review Checklist
            - [ ] Reviewed skill content changes
            - [ ] Verified no breaking changes
            - [ ] Tested installation with `./install.sh`
          branch: chore/sync-skills
          delete-branch: true
          labels: |
            automated
            skills

